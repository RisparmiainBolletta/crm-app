<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>CRM - Clienti</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f8fb;
      color: #333;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background-color: #3498db;
      padding: 15px 20px;
      border-radius: 6px;
      color: white;
    }

    .logout {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background-color: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      border-bottom: 1px solid #eee;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #f0f6fa;
      color: #333;
    }

    input, select {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      max-width: 300px;
    }

    button {
      cursor: pointer;
    }

    .carica-btn {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 4px;
      background-color: #3498db;
      color: white;
      border: none;
      width: 100px;
    }

    .elimina-btn {
      font-size: 12px;
      padding: 4px 8px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 80px;
      margin-left: 10px;
    }

    .aggiungi-btn {
      font-size: 13px;
      padding: 6px 12px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 140px;
      font-weight: bold;
      margin-top: 10px;
    }

    .aggiungi-inter-btn {
      font-size: 12px;
      padding: 5px 10px;
      background-color: #8e44ad;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 6px;
      width: 100px;
    }

    .aggiungi-btn:hover { background-color: #27ae60; }
    .carica-btn:hover { background-color: #2980b9; }
    .elimina-btn:hover { background-color: #c0392b; }
    .aggiungi-inter-btn:hover { background-color: #732d91; }

    .sezione-extra {
      margin: 10px 0 30px 0;
      background: #ffffff;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .mini-btn {
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      color: #3498db;
    }

    .approvato { color: green; }
    .in-attesa { color: orange; }

    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <header>
    <h2>Benvenuto, <span id="Nome">Agente</span></h2>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <h3>Aggiungi nuovo cliente</h3>
  <form id="form-cliente">
    <input type="text" placeholder="Nome" id="nome" required>
    <input type="email" placeholder="Email" id="email" required>
    <input type="text" placeholder="Telefono" id="telefono" required>
    <select id="stato" required>
      <option value="">-- Caricamento stati... --</option>
    </select>
    <button type="submit" class="aggiungi-btn">‚ûï Aggiungi</button>
  </form>

  <p id="messaggio-successo" style="color: green; font-weight: bold;"></p>

  <h3>Lista Clienti</h3>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Telefono</th>
        <th>Agente</th>
        <th>Stato</th>
        <th>Provvigione</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody id="clienti-body"></tbody>
  </table>

  <script>
    function logout() {
      window.location.href = "/logout";
    }

function caricaClienti() {
  fetch('/clienti')
    .then(res => res.json())
    .then(clienti => {
      fetch('/notifiche-non-letto')
        .then(res => res.json())
        .then(notifiche => {
          const tbody = document.getElementById('clienti-body');
          tbody.innerHTML = '';

          clienti.forEach(cliente => {
            const haNotifica = notifiche.includes(cliente.ID_Cliente);
            const iconaNotifica = haNotifica ? 'üîî' : '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${cliente.ID_Cliente}</td>
              <td>${cliente.Nome} ${iconaNotifica}</td>
              <td>${cliente.Email}</td>
              <td>${cliente.Telefono}</td>
              <td>${cliente.Agente}</td>
              <td>${cliente.Stato}</td>
              <td>${cliente.Provvigione}</td>
              <td>
                <span class="mini-btn" onclick="mostraInterazioni('${cliente.ID_Cliente}')">üìã Interazioni</span>
                <span class="mini-btn" onclick="mostraDocumenti('${cliente.ID_Cliente}')" id="doc-btn-${cliente.ID_Cliente}">üìé Documenti</span>
              </td>
            `;
            tbody.appendChild(tr);

            const extraRow = document.createElement('tr');
            const extraCell = document.createElement('td');
            extraCell.colSpan = 8;
            extraCell.innerHTML = `<div id="extra-${cliente.ID_Cliente}"></div>`;
            extraRow.appendChild(extraCell);
            tbody.appendChild(extraRow);
          });

          aggiornaConteggioDocumenti(); // ‚úÖ Una sola chiamata alla fine
        });
    });
}

  function aggiornaConteggioDocumenti() {
    fetch("/conteggio-documenti")
      .then(res => res.json())
      .then(conteggi => {
        Object.entries(conteggi).forEach(([idCliente, numero]) => {
          const btn = document.getElementById(`doc-btn-${idCliente}`);
          if (btn) {
            btn.innerHTML = `üìé Documenti (${numero})`;
          }
        });
      });
  }

    
    function contaDocumenti(idCliente) {
      fetch(`/files/${idCliente}`)
        .then(res => res.json())
        .then(data => {
          const btn = document.getElementById(`doc-btn-${idCliente}`);
          if (btn) {
            btn.innerHTML = `üìé Documenti (${data.length})`;
            if (data.some(f => f.stato === "In attesa")) {
              btn.innerHTML += ' üîî';
            }
          }
        });
    }

    async function mostraDocumenti(idCliente) {
      const container = document.getElementById(`extra-${idCliente}`);
      container.innerHTML = `
        <div class="sezione-extra">
          <h4>Documenti per ${idCliente}</h4>
          <div id="loader-${idCliente}" class="loader"></div>
          <form onsubmit="uploadFile(event, '${idCliente}')">
            <input type="file" id="file-${idCliente}" required>
            <button type="submit" class="carica-btn">Carica</button>
          </form>
          <div id="lista-documenti-${idCliente}"></div>
        </div>
      `;

      document.getElementById(`loader-${idCliente}`).style.display = "block";

      try {
        await caricaDocumenti(idCliente);
        await fetch(`/files/segna-letti/${idCliente}`, { method: "POST" });
        const btn = document.getElementById(`doc-btn-${idCliente}`);
        if (btn) btn.innerHTML = "üìé Documenti";
      } catch (e) {
        console.error(e);
      } finally {
        document.getElementById(`loader-${idCliente}`).style.display = "none";
      }
    }

    function uploadFile(e, idCliente) {
      e.preventDefault();
      const fileInput = document.getElementById(`file-${idCliente}`);
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      fetch(`/upload/${idCliente}`, {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(() => caricaDocumenti(idCliente));
    }

    function caricaDocumenti(idCliente) {
      fetch(`/files/${idCliente}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById(`lista-documenti-${idCliente}`);
          if (!data || data.length === 0) {
            container.innerHTML = "<p>Nessun documento caricato.</p>";
            return;
          }
    
          let html = "<ul>";
          data.forEach(doc => {
            const stato = doc.stato === "Approvato" ? "‚úÖ" :
                          doc.stato === "ELIMINATO" ? "‚ùå" : "‚è≥";
    
            const colore = doc.stato === "Approvato" ? "approvato" :
                           doc.stato === "ELIMINATO" ? "in-attesa" : "in-attesa";
    
            html += `<li>
              <a href="${doc.url}" target="_blank">${doc.name}</a>
              <span class="${colore}"> ${stato} ${doc.stato}</span>
              ${doc.stato !== "Approvato" && doc.stato !== "ELIMINATO" ? 
                `<button class="elimina-btn" onclick="eliminaFile('${doc.id}', '${idCliente}')">üóë</button>` : ""}
            </li>`;
          });
    
          html += "</ul>";
          container.innerHTML = html;
        });
    }

    function eliminaFile(idFile, idCliente) {
      if (!confirm("Sei sicuro di voler eliminare questo file?")) return;
    
      fetch(`/file/${idFile}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          console.log(data.message);
          caricaDocumenti(idCliente);
        });
    }


    function mostraInterazioni(idCliente) {
      const container = document.getElementById(`extra-${idCliente}`);
      container.innerHTML = `
        <div class="sezione-extra">
          <h4>Interazioni per ${idCliente}</h4>
          <form onsubmit="aggiungiInterazione(event, '${idCliente}')">
            <input type="date" id="data-${idCliente}" required>
            <select id="tipo-${idCliente}" required><option value="">Tipo...</option></select>
            <select id="esito-${idCliente}" required><option value="">Esito...</option></select>
            <input type="text" id="descrizione-${idCliente}" placeholder="Descrizione" required>
            <button type="submit" class="aggiungi-inter-btn">‚ûï Aggiungi</button>
          </form>
          <div id="lista-interazioni-${idCliente}"></div>
        </div>
      `;
      caricaTipiInterazione(`tipo-${idCliente}`);
      caricaEsitiInterazione(`esito-${idCliente}`);
      caricaInterazioni(idCliente);
    }

    function caricaInterazioni(idCliente) {
      fetch(`/interazioni/${idCliente}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById(`lista-interazioni-${idCliente}`);
          if (!data || data.length === 0) {
            container.innerHTML = "<p>Nessuna interazione registrata.</p>";
            return;
          }

          data.sort((a, b) => {
            const parse = d => {
              const [gg, mm, aa] = d.split("/"); return new Date(`${aa}-${mm}-${gg}`);
            };
            return parse(b.Data) - parse(a.Data);
          });

          let html = `
            <table>
              <thead><tr><th>Data</th><th>Tipo</th><th>Esito</th><th>Descrizione</th></tr></thead>
              <tbody>
          `;
          data.forEach(i => {
            html += `<tr><td>${i.Data}</td><td>${i.Tipo}</td><td>${i.Esito}</td><td>${i.Descrizione}</td></tr>`;
          });
          html += `</tbody></table>`;
          container.innerHTML = html;
        });
    }

    function aggiungiInterazione(e, idCliente) {
      e.preventDefault();
      const payload = {
        ID_Cliente: idCliente,
        Data: document.getElementById(`data-${idCliente}`).value,
        Tipo: document.getElementById(`tipo-${idCliente}`).value,
        Esito: document.getElementById(`esito-${idCliente}`).value,
        Descrizione: document.getElementById(`descrizione-${idCliente}`).value
      };
      fetch('/interazioni', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(() => caricaInterazioni(idCliente));
    }

    function caricaTipiInterazione(selectId) {
      fetch("/tipi-interazione")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Seleziona tipo --</option>';
          data.forEach(tipo => {
            const opt = document.createElement("option");
            opt.value = tipo;
            opt.textContent = tipo;
            select.appendChild(opt);
          });
        });
    }

    function caricaEsitiInterazione(selectId) {
      fetch("/esiti-interazione")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Seleziona esito --</option>';
          data.forEach(esito => {
            const opt = document.createElement("option");
            opt.value = esito;
            opt.textContent = esito;
            select.appendChild(opt);
          });
        });
    }

    function caricaStatiCliente() {
      fetch("/stati-cliente")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("stato");
          select.innerHTML = '<option value="">-- Seleziona stato --</option>';
          data.forEach(stato => {
            const opt = document.createElement("option");
            opt.value = stato;
            opt.textContent = stato;
            select.appendChild(opt);
          });
        });
    }

    document.getElementById("form-cliente").addEventListener("submit", function (e) {
      e.preventDefault();
      const nuovoCliente = {
        Nome: document.getElementById('nome').value,
        Email: document.getElementById('email').value,
        Telefono: document.getElementById('telefono').value,
        Stato: document.getElementById('stato').value
      };

      fetch('/clienti', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(nuovoCliente)
      })
        .then(res => res.json())
        .then(data => {
          caricaClienti();
          document.getElementById("form-cliente").reset();
          const msg = document.getElementById("messaggio-successo");
          msg.textContent = data.message;
          setTimeout(() => msg.textContent = "", 5000);
        });
    });

    window.addEventListener('DOMContentLoaded', () => {
      caricaClienti();
      caricaStatiCliente();
      mostraDatiAgente();
    });
    function mostraDatiAgente() {
      fetch("/dati-agente")
        .then(res => res.json())
        .then(data => {
          const nomeCompleto = data.nome_completo || "Agente";
          const codice = data.codice || "";
          document.getElementById("nome-agente").textContent = `${nomeCompleto} - ${codice}`;
        });
    }

  </script>
</body>
</html>
