<!-- index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>CRM - Clienti</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout { background: #e74c3c; color: white; border: none; padding: 8px 16px; cursor: pointer; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
        input, select, button { padding: 8px; margin: 5px 0; max-width: 300px; width: 100%; }
        .sezione-extra { margin: 10px 0 30px 0; background: #f9f9f9; padding: 15px; border: 1px solid #ccc; }
        .mini-btn { cursor: pointer; font-size: 14px; margin-right: 8px; }
        .approvato { color: green; }
        .in-attesa { color: orange; }
    </style>
</head>
<body>

<header>
    <h2>Benvenuto, <span id="nome-agente">Agente</span></h2>
    <button class="logout" onclick="logout()">Logout</button>
</header>

<h3>Aggiungi nuovo cliente</h3>
<form id="form-cliente">
    <input type="text" placeholder="Nome" id="nome" required>
    <input type="email" placeholder="Email" id="email" required>
    <input type="text" placeholder="Telefono" id="telefono" required>
    <select id="stato" required>
        <option value="">-- Caricamento stati... --</option>
    </select>
    <button type="submit">Aggiungi Cliente</button>
</form>
<p id="messaggio-successo" style="color: green; font-weight: bold;"></p>

<hr>
<h3>Modifica cliente</h3>
<input type="text" id="ricerca-cliente" placeholder="Cerca per ID o Nome" oninput="cercaCliente()" />
<div id="modifica-cliente-box" style="display: none; margin-top: 10px;">
  <form id="form-modifica-cliente">
    <input type="text" id="mod-id" disabled />
    <input type="text" id="mod-nome" required />
    <input type="email" id="mod-email" required />
    <input type="text" id="mod-telefono" required />
    <select id="mod-stato" required>
      <option value="">-- Caricamento stati... --</option>
    </select>
    <button type="submit">Salva modifiche</button>
  </form>
</div>

<h3>Lista Clienti</h3>
<table>
    <thead>
        <tr>
            <th>ID</th><th>Nome</th><th>Email</th><th>Telefono</th><th>Agente</th><th>Stato</th><th>Provvigione</th><th>Azioni</th>
        </tr>
    </thead>
    <tbody id="clienti-body"></tbody>
</table>

<script>
function logout() {
    window.location.href = "/logout";
}

// =========================== CLIENTI ===========================
function caricaClienti() {
    fetch('/clienti')
        .then(res => {
            if (res.status === 401) window.location.href = "/";
            return res.json();
        })
        .then(data => {
            if (data.length > 0) {
                document.getElementById("nome-agente").textContent = data[0].Agente || "Agente";
            }
            const tbody = document.getElementById('clienti-body');
            tbody.innerHTML = '';
            data.forEach(cliente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                  <td>${cliente.ID_Cliente}</td>
                  <td>${cliente.Nome}</td>
                  <td>${cliente.Email}</td>
                  <td>${cliente.Telefono}</td>
                  <td>${cliente.Agente}</td>
                  <td>${cliente.Stato}</td>
                  <td>${cliente.Provvigione}</td>
                  <td>
                    <span class="mini-btn" onclick="mostraInterazioni('${cliente.ID_Cliente}')">📋 Interazioni</span>
                    <span class="mini-btn" onclick="mostraDocumenti('${cliente.ID_Cliente}')">📎 Documenti</span>
                  </td>
                `;
                tbody.appendChild(tr);

                const extraRow = document.createElement('tr');
                const extraCell = document.createElement('td');
                extraCell.colSpan = 8;
                extraCell.innerHTML = `<div id="extra-${cliente.ID_Cliente}"></div>`;
                extraRow.appendChild(extraCell);
                tbody.appendChild(extraRow);
            });
        });
}

document.getElementById("form-cliente").addEventListener("submit", function (e) {
    e.preventDefault();
    const nuovoCliente = {
        Nome: document.getElementById('nome').value,
        Email: document.getElementById('email').value,
        Telefono: document.getElementById('telefono').value,
        Stato: document.getElementById('stato').value
    };
    fetch('/clienti', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(nuovoCliente)
    })
    .then(res => res.json())
    .then(data => {
        caricaClienti();
        document.getElementById("form-cliente").reset();
        const msg = document.getElementById("messaggio-successo");
        msg.textContent = data.message;
        setTimeout(() => msg.textContent = "", 5000);
    });
});

// =========================== MODIFICA CLIENTE ===========================
function cercaCliente() {
    const query = document.getElementById("ricerca-cliente").value.toLowerCase();
    if (!query) {
        document.getElementById("modifica-cliente-box").style.display = "none";
        return;
    }

    fetch("/clienti")
        .then(res => res.json())
        .then(data => {
            const cliente = data.find(c =>
                c.ID_Cliente.toLowerCase().includes(query) ||
                c.Nome.toLowerCase().includes(query)
            );
            if (cliente) {
                document.getElementById("mod-id").value = cliente.ID_Cliente;
                document.getElementById("mod-nome").value = cliente.Nome;
                document.getElementById("mod-email").value = cliente.Email;
                document.getElementById("mod-telefono").value = cliente.Telefono;
                caricaStatiCliente("mod-stato");
                // Asincrono: aspetta caricamento stati
                setTimeout(() => {
                    document.getElementById("mod-stato").value = cliente.Stato;
                }, 200);
                document.getElementById("modifica-cliente-box").style.display = "block";
            } else {
                document.getElementById("modifica-cliente-box").style.display = "none";
            }
        });
}

document.getElementById("form-modifica-cliente").addEventListener("submit", function(e) {
    e.preventDefault();
    const id = document.getElementById("mod-id").value;
    const clienteAggiornato = {
        Nome: document.getElementById("mod-nome").value,
        Email: document.getElementById("mod-email").value,
        Telefono: document.getElementById("mod-telefono").value,
        Stato: document.getElementById("mod-stato").value
    };
    fetch(`/clienti/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(clienteAggiornato)
    })
    .then(res => res.json())
    .then(data => {
        caricaClienti();
        document.getElementById("form-modifica-cliente").reset();
        document.getElementById("ricerca-cliente").value = "";
        document.getElementById("modifica-cliente-box").style.display = "none";
        alert(data.message);
    });
});

// =========================== INTERAZIONI ===========================
function mostraInterazioni(idCliente) {
    const container = document.getElementById(`extra-${idCliente}`);
    container.innerHTML = `
      <div class="sezione-extra">
        <h4>Interazioni per ${idCliente}</h4>
        <form onsubmit="aggiungiInterazione(event, '${idCliente}')">
          <input type="date" id="data-${idCliente}" required>
          <select id="tipo-${idCliente}" required>
            <option value="">-- Caricamento tipi... --</option>
          </select>
          <select id="esito-${idCliente}" required>
            <option value="">-- Caricamento esiti... --</option>
          </select>
          <input type="text" id="descrizione-${idCliente}" placeholder="Descrizione" required>
          <button type="submit">Aggiungi</button>
        </form>
        <div id="lista-interazioni-${idCliente}"></div>
      </div>
    `;
    caricaTipiInterazione(`tipo-${idCliente}`);
    caricaEsitiInterazione(`esito-${idCliente}`);
    caricaInterazioni(idCliente);
}

function caricaInterazioni(idCliente) {
    fetch(`/interazioni/${idCliente}`)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById(`lista-interazioni-${idCliente}`);
        if (!data || data.length === 0) {
            container.innerHTML = "<p>Nessuna interazione registrata.</p>";
            return;
        }
        // Mostriamo in tabella
        let html = `<table><thead><tr><th>Data</th><th>Tipo</th><th>Esito</th><th>Descrizione</th></tr></thead><tbody>`;
        data.forEach(i => {
            html += `<tr>
              <td>${i.Data}</td>
              <td>${i.Tipo}</td>
              <td>${i.Esito}</td>
              <td>${i.Descrizione}</td>
            </tr>`;
        });
        html += "</tbody></table>";
        container.innerHTML = html;
    });
}

function aggiungiInterazione(e, idCliente) {
    e.preventDefault();
    const payload = {
        ID_Cliente: idCliente,
        Data: document.getElementById(`data-${idCliente}`).value,
        Tipo: document.getElementById(`tipo-${idCliente}`).value,
        Esito: document.getElementById(`esito-${idCliente}`).value,
        Descrizione: document.getElementById(`descrizione-${idCliente}`).value
    };
    fetch('/interazioni', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(() => caricaInterazioni(idCliente));
}

// =========================== DOCUMENTI ===========================
function mostraDocumenti(idCliente) {
    const container = document.getElementById(`extra-${idCliente}`);
    container.innerHTML = `
      <div class="sezione-extra">
        <h4>Documenti per ${idCliente}</h4>
        <form onsubmit="uploadFile(event, '${idCliente}')">
          <input type="file" id="file-${idCliente}" required>
          <button type="submit">Carica</button>
        </form>
        <div id="lista-documenti-${idCliente}"></div>
      </div>
    `;
    caricaDocumenti(idCliente);
}

function uploadFile(e, idCliente) {
    e.preventDefault();
    const fileInput = document.getElementById(`file-${idCliente}`);
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    fetch(`/upload/${idCliente}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(() => caricaDocumenti(idCliente));
}

function caricaDocumenti(idCliente) {
    fetch(`/files/${idCliente}`)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById(`lista-documenti-${idCliente}`);
        if (!data || data.length === 0) {
            container.innerHTML = "<p>Nessun documento caricato.</p>";
            return;
        }
        let html = "<ul>";
        data.forEach(doc => {
            const stato = doc.stato === "Approvato" ? "✅" : "⏳";
            const colore = doc.stato === "Approvato" ? "approvato" : "in-attesa";
            html += `<li>
                <a href="${doc.url}" target="_blank">${doc.name}</a>
                <span class="${colore}"> ${stato} ${doc.stato}</span>
                ${doc.stato !== "Approvato" ? `<button onclick="eliminaFile('${doc.id}', '${idCliente}')">🗑</button>` : ""}
            </li>`;
        });
        html += "</ul>";
        container.innerHTML = html;
    });
}

function eliminaFile(idFile, idCliente) {
    if (!confirm("Sei sicuro di voler eliminare questo file?")) return;
    fetch(`/file/${idFile}`, { method: 'DELETE' })
    .then(res => {
        if (res.status === 403) {
            alert("Il file è stato approvato e non può essere eliminato.");
        } else {
            caricaDocumenti(idCliente);
        }
    });
}

// =========================== MENU DINAMICI ===========================
function caricaTipiInterazione(selectId) {
    fetch("/tipi-interazione")
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Seleziona tipo --</option>';
        data.forEach(tipo => {
            const opt = document.createElement("option");
            opt.value = tipo;
            opt.textContent = tipo;
            select.appendChild(opt);
        });
    });
}

function caricaEsitiInterazione(selectId) {
    fetch("/esiti-interazione")
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Seleziona esito --</option>';
        data.forEach(esito => {
            const opt = document.createElement("option");
            opt.value = esito;
            opt.textContent = esito;
            select.appendChild(opt);
        });
    });
}

function caricaStatiCliente(selectId = "stato") {
    fetch("/stati-cliente")
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Seleziona stato --</option>';
        data.forEach(stato => {
            const opt = document.createElement("option");
            opt.value = stato;
            opt.textContent = stato;
            select.appendChild(opt);
        });
    });
}

// =========================== AVVIO PAGINA ===========================
window.addEventListener('DOMContentLoaded', () => {
    caricaClienti();
    caricaStatiCliente();
});
</script>
</body>
</html>
